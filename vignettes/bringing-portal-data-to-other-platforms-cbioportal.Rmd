---
title: "Bringing Portal Data to Other Platforms: cBioPortal"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Bringing Portal Data to Other Platforms: cBioPortal}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

**Document Status:** Draft  
**Estimated Reading Time:** 8 min

## Special acknowledgments 

Functionality demonstrated in this vignette benefited greatly from code originally written by [hhunterzinck](https://github.com/hhunterzinck). 

## Intro

This describes how to package some Synapse processed data as a cBioPortal study dataset.
A cBioPortal study contains one or more data types, see [cBioPortal docs](https://docs.cbioportal.org/file-formats/). 
The current API covers creating a cBioPortal study with a subset of data types relevant to the NF workflow (so not all data types). 
The design has been inspired by and should feel somewhat like working with the R package [usethis](https://github.com/r-lib/usethis), 
and data types can be added to the study package interactively.

Though there is some checking depending on the data type, final validation with the official cBioPortal validation tools/scripts should still be run (see last section).

Breaking changes are possible as the API is still in development.

## Set up

First load the `nfportalutils` package and log in. 
The recommended default usage of `syn_login` is to use it without directly passing in credentials. 
Instead, have available the `SYNAPSE_AUTH_TOKEN` environment variable with your token stored therein. 

```{r setup, eval=TRUE}
library(nfportalutils)
syn_login()

```

## Create a new study dataset

First create the study before we can put together the data.
In this case we set validate = `FALSE`, but if set to true it will check `type_of_cancer` against the cBioPortal public API.

```{r cbp_new_study, eval=TRUE}

cbp_new_study(cancer_study_identifier = study_id,
              name = "Plexiform Neurofibroma (Smith 2022)",
              type_of_cancer = "npst",
              citation = "TBD", 
              validate = FALSE)

```

## Add data types to study

Data types can be added _in any order_ using the `cbp_add*` functions.
These convenience utils download data files and create the meta for them and expects certain **defaults for NF-OSI processed data**. 
(If sometimes these defaults don't match what you want, take a look at the lower-level utils `make_meta_*` or edit the files manually after.)

**Note 1**: If you use `cbp_add*` for a dataset with existing data, this will replace the same data type already in the dataset.

**Note 2**: We have to be in a valid cBioPortal study directory set up in the previous step. 
This is intentional because it can automatically and consistently use the whatever study id is in the current study meta file.
But because Rmarkdown files assume the working directory is where the Rmarkdown document is located, we have to force `setwd()` each time. 
*If running outside of Rmarkdown, i.e. typing commands directly into console, you don't need to use `setwd()` each time.*

### Add mutations data

- `maf_data` references a final merged maf output file from the NF-OSI processing pipeline OK for public release. 
No further modifications are done except renaming it.

```{r add_maf, eval=FALSE}

setwd(study_id)

maf_data <- "syn52073131"
cbp_add_maf(maf_data)
```

### Add copy number alterations (CNA) data

- `cna_data` is mostly expected as discrete data, [GISTIC 2.0 format](https://docs.cbioportal.org/file-formats/#gistic-20-format) `.txt` file on Synapse.

```{r add_cna, eval=FALSE}

setwd(study_id)

cna_data <- "syn********"
cbp_add_cna(cna_data)
```

### Add expression data

...By the time of this third and final data type addition, we should hopefully have the gist of adding to the dataset. 

- `expression_data` is expected to be a `.tsv` or `.txt` file on Synapse.

```{r add_expression, eval=FALSE}

setwd(study_id)

mrna_data <- "syn********"
cbp_add_expression(mrna_data)
```


### Add clinical data

- `ref_view` is a fileview that contains clinical data for the data released in the study.
- `ref_map` maps clinical variables from the NF-OSI data dictionary to cBioPortal's

```{r add_clinical, eval=FALSE}

setwd(study_id)

ref_view <- "syn43278088"
ref_map <- "https://raw.githubusercontent.com/nf-osi/nf-metadata-dictionary/main/mappings/cBioPortal.yaml"

cbp_add_clinical(ref_view, ref_map)
```

## Validation

### With cBioPortal tooling

Additional steps such as generating case lists and validation have to be done _outside_ of this package with a cBioPortal backend. 
The portal instance you are targeting has its own specific configuration (for genomic reference, certain types of enum values, etc.) to validate against.
See the [general docs for dataset validation](https://docs.cbioportal.org/using-the-dataset-validator/).

For the _public_ portal, the suggested step using the public server/tools is given below.  

Assuming your present working directory is `~/datahub/public` and a study folder called `mixed_nfosi_2022` has been placed into it, mount the dataset into the container and run validation with:  
`docker run --rm -v $(pwd):/datahub cbioportal/cbioportal:4.1.13 validateStudies.py -d /datahub -l mixed_nfosi_2022 -u http://cbioportal.org -html /datahub/mixed_nfosi_2022/html_report`

